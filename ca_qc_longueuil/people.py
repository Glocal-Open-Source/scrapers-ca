from __future__ import unicode_literals
from utils import CanadianScraper, CanadianPerson as Person

COUNCIL_PAGE = 'https://www.longueuil.quebec/fr/conseil-ville'


class LongueuilPersonScraper(CanadianScraper):

    def scrape(self):
        page = self.lxmlize(COUNCIL_PAGE, 'utf-8')

        yield self.scrape_mayor(page)

        trs = page.xpath('//tbody/tr')
        assert len(trs), 'No councillors found'
        seat_number = 1
        for tr in trs:
            if tr.xpath('./td[2]//text()')[0] != 'Vacant':
                district = tr.xpath('./td[1]/text()')[0]
                if 'Greenfield Park' in district or 'Conseiller n' in district:
                    district = 'Greenfield Park (si√®ge {})'.format(seat_number)
                    seat_number += 1
                detail_url = tr.xpath('./td[2]/a/@href')[0]
                detail_page = self.lxmlize(detail_url, 'utf-8')

                name = detail_page.xpath('//h1/text()')[0]
                photo_node = detail_page.xpath('//img[contains(@alt, "{0}")]/@src'.format(name))
                if photo_node:
                    photo_url = photo_node[0]
                else:
                    photo_url = detail_page.xpath('//img[contains(@class, "droite")]/@src')[0]

                p = Person(primary_org='legislature', name=name, district=district, role='Conseiller')
                p.add_source(COUNCIL_PAGE)
                p.add_source(detail_url)
                p.image = photo_url
                p.add_contact('email', self.get_email(detail_page))
                yield p

    def scrape_mayor(self, page):
        mayor_node = page.xpath('//a[contains(@href, "maire")]/ancestor::strong')[0]
        name, position = [string.title() for string in mayor_node.text_content().split(', ')]
        mayor_url = mayor_node.xpath('.//a/@href')[0]
        mayor_page = self.lxmlize(mayor_url)
        photo_url = mayor_page.xpath('//img[contains(@alt, "{0}")]/@src'.format(name))[0]
        p = Person(primary_org='legislature', name=name, district='Longueuil', role='Maire')
        p.add_source(COUNCIL_PAGE)
        p.add_source(mayor_url)
        p.image = photo_url
        p.add_contact('email', self.get_email(mayor_page))
        yield p
